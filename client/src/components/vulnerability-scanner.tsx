import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { useMutation, useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Separator } from "@/components/ui/separator";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { useToast } from "@/hooks/use-toast";
import { apiRequest } from "@/lib/queryClient";
import { AlertOctagon, AlertTriangle, Shield, Key, Copy, Eye, Send, Wallet, Settings, CheckCircle, Code, Loader2 } from "lucide-react";

const addressSchema = z.object({
  address: z.string().min(1, "Bitcoin address is required"),
});

const transactionSchema = z.object({
  fromAddress: z.string().min(1, "Source address is required"),
  toAddress: z.string().min(1, "Destination address is required"),
  amount: z.string().min(1, "Amount is required"),
  privateKey: z.string().min(1, "Private key is required"),
});

  const derSignSchema = z.object({
    rawTransaction: z.string().min(1, "Raw transaction is required"),
    rValue: z.string().min(1, "R value is required"),
    sValue: z.string().min(1, "S value is required"),
    sighashType: z.string().optional(),
    publicKey: z.string().optional(),
  });

  const rawTxSchema = z.object({
    version: z.string().optional(),
    inputs: z.array(z.object({
      txid: z.string().min(1, "Transaction ID is required"),
      vout: z.string().min(1, "Output index is required"),
      scriptSig: z.string().optional(),
      sequence: z.string().optional(),
    })).min(1, "At least one input is required"),
    outputs: z.array(z.object({
      value: z.string().min(1, "Value is required"),
      scriptPubKey: z.string().min(1, "Script is required"),
    })).min(1, "At least one output is required"),
    locktime: z.string().optional(),
  });

type AddressForm = z.infer<typeof addressSchema>;
type TransactionForm = z.infer<typeof transactionSchema>;
type DerSignForm = z.infer<typeof derSignSchema>;
type RawTxForm = z.infer<typeof rawTxSchema>;

interface VulnerabilityResult {
  vulnerabilities: Array<{
    type: string;
    severity: 'low' | 'medium' | 'high' | 'critical';
    description: string;
    affectedTransactions: string[];
    recoveredData?: any;
    educational: boolean;
  }>;
  signatureAnalysis: {
    totalSignatures: number;
    uniqueRValues: number;
    weakPatterns: any[];
    entropyAnalysis: any;
  };
  nonceReuse: Array<{
    rValue: string;
    affectedSignatures: any[];
    recoveredPrivateKey?: string;
    confidence: number;
  }>;
  recoveredKeys: Array<{
    privateKey: string;
    format: string;
    method: string;
    confidence: number;
    educational: true;
  }>;
}

interface VulnerabilityScannerProps {
  address?: string;
  analysisId?: string;
}

export function VulnerabilityScanner({ address, analysisId }: VulnerabilityScannerProps = {}) {
  const [scanResult, setScanResult] = useState<VulnerabilityResult | null>(null);
  const [selectedVuln, setSelectedVuln] = useState<any>(null);
  const { toast } = useToast();

  const runVulnerabilityScan = useMutation({
    mutationFn: async ({ address, analysisId }: { address: string; analysisId?: string }) => {
      const response = await apiRequest('POST', '/api/vulnerability-test', {
        address,
        analysisId,
      });
      return response.json();
    },
    onSuccess: (result) => {
      setScanResult(result.data);
      toast({
        title: "Vulnerability Scan Complete",
        description: `Found ${result.data.vulnerabilities.length} vulnerabilities, ${result.data.recoveredKeys.length} recovered keys`,
      });
    },
    onError: (error) => {
      toast({
        title: "Scan Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast({
      title: "Copied",
      description: "Content copied to clipboard",
    });
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'text-destructive border-destructive/20 bg-destructive/5';
      case 'high': return 'text-orange-500 border-orange-500/20 bg-orange-500/5';
      case 'medium': return 'text-yellow-500 border-yellow-500/20 bg-yellow-500/5';
      case 'low': return 'text-blue-500 border-blue-500/20 bg-blue-500/5';
      default: return 'text-muted-foreground border-border bg-muted/5';
    }
  };

  const getSeverityIcon = (severity: string) => {
    switch (severity) {
      case 'critical': return <AlertTriangle className="w-4 h-4" />;
      case 'high': return <Shield className="w-4 h-4" />;
      default: return <AlertOctagon className="w-4 h-4" />;
    }
  };

  const [transactionResult, setTransactionResult] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'scan' | 'transaction' | 'der' | 'rawtx'>('scan');
  const [utxoAddress, setUtxoAddress] = useState("");
  const [utxoList, setUtxoList] = useState<any[]>([]);
  const [utxoLoading, setUtxoLoading] = useState(false);
  const [showUtxos, setShowUtxos] = useState(false);
  const [builtRawTx, setBuiltRawTx] = useState("");
  const [broadcastLoading, setBroadcastLoading] = useState(false);
  const [broadcastResult, setBroadcastResult] = useState<any>(null);

  const addressForm = useForm<AddressForm>({
    resolver: zodResolver(addressSchema),
  });

  const transactionForm = useForm<TransactionForm>({
    resolver: zodResolver(transactionSchema),
  });

  const derSignForm = useForm<DerSignForm>({
    resolver: zodResolver(derSignSchema),
  });

  const rawTxForm = useForm<RawTxForm>({
    resolver: zodResolver(rawTxSchema),
    defaultValues: {
      version: "1",
      inputs: [{ txid: "", vout: "", scriptSig: "", sequence: "ffffffff" }],
      outputs: [{ value: "", scriptPubKey: "" }],
      locktime: "0",
    },
  });

  const vulnerabilityScan = useMutation({
    mutationFn: async (data: AddressForm) => {
      const response = await apiRequest('POST', '/api/vulnerability-test', {
        address: data.address,
      });
      return response.json();
    },
    onSuccess: (result) => {
      setScanResult(result.data);
      toast({
        title: "Vulnerability Scan Complete",
        description: `Found ${result.data.vulnerabilities.length} vulnerabilities`,
      });
    },
    onError: (error) => {
      toast({
        title: "Scan Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const createTransaction = useMutation({
    mutationFn: async (data: TransactionForm) => {
      const response = await apiRequest('POST', '/api/create-transaction', data);
      return response.json();
    },
    onSuccess: (result) => {
      setTransactionResult(result.data.rawTransaction);
      toast({
        title: "Transaction Created",
        description: "Transaction with DER signature created successfully",
      });
    },
    onError: (error) => {
      toast({
        title: "Transaction Creation Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const forgeSignature = useMutation({
    mutationFn: async (rawTransaction: string) => {
      const response = await apiRequest('POST', '/api/forge-signature', {
        rawTransaction,
        malleabilityType: 'sighash_single'
      });
      return response.json();
    },
    onSuccess: (result) => {
      setTransactionResult(result.data.malleableTransaction);
      toast({
        title: "Signature Forged",
        description: "Malleable signature created with serialization",
      });
    },
    onError: (error) => {
      toast({
        title: "Signature Forgery Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const signTransactionWithDer = useMutation({
    mutationFn: async (data: DerSignForm) => {
      const response = await apiRequest('POST', '/api/sign-transaction-der', data);
      return response.json();
    },
    onSuccess: (result) => {
      setTransactionResult(result.data.signedTransaction);
      toast({
        title: "Transaction Signed",
        description: "Transaction signed successfully with DER components",
      });
    },
    onError: (error) => {
      toast({
        title: "Transaction Signing Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const createRawTransaction = useMutation({
    mutationFn: async (data: RawTxForm) => {
      const response = await apiRequest('POST', '/api/create-raw-transaction', data);
      return response.json();
    },
    onSuccess: (result) => {
      setTransactionResult(result.data.rawTransaction);
      toast({
        title: "Raw Transaction Created",
        description: "Unsigned raw transaction created successfully",
      });
    },
    onError: (error) => {
      toast({
        title: "Raw Transaction Creation Failed",
        description: error.message,
        variant: "destructive",
      });
    },
  });


  const onScanSubmit = (data: AddressForm) => {
    vulnerabilityScan.mutate(data);
  };

  const onTransactionSubmit = (data: TransactionForm) => {
    createTransaction.mutate(data);
  };

  const onDerSignSubmit = (data: DerSignForm) => {
    signTransactionWithDer.mutate(data);
  };

  const onRawTxSubmit = (data: RawTxForm) => {
    createRawTransaction.mutate(data);
  };

  const fetchUtxosForRawTx = async () => {
    if (!utxoAddress.trim()) {
      toast({ title: "Error", description: "Enter Bitcoin address", variant: "destructive" });
      return;
    }
    setUtxoLoading(true);
    try {
      const res = await fetch("/api/get-utxos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: utxoAddress }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      setUtxoList(data.data.utxos);
      setShowUtxos(true);
      toast({ title: "Success", description: `Found ${data.data.count} UTXOs` });
    } catch (e) {
      toast({ title: "Error", description: (e as Error).message, variant: "destructive" });
    } finally {
      setUtxoLoading(false);
    }
  };

  const addUtxoToRawTx = (utxo: any) => {
    const inputs = rawTxForm.getValues("inputs");
    rawTxForm.setValue("inputs", [...inputs, {
      txid: utxo.txid,
      vout: utxo.vout.toString(),
      sequence: "ffffffff",
      scriptSig: ""
    }]);
    toast({ title: "Added", description: `UTXO added as input` });
  };

  const broadcastRawTx = async () => {
    if (!builtRawTx) {
      toast({ title: "Error", description: "Build a transaction first", variant: "destructive" });
      return;
    }
    setBroadcastLoading(true);
    try {
      const res = await fetch("/api/broadcast-tx", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ txHex: builtRawTx }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      setBroadcastResult(data.data);
      toast({ title: "Success", description: "Transaction broadcast!" });
    } catch (e) {
      toast({ title: "Error", description: (e as Error).message, variant: "destructive" });
    } finally {
      setBroadcastLoading(false);
    }
  };

  // Renamed copyToClipboard to avoid conflict with the one above
  const copyToClipboardTransaction = (text: string) => {
    navigator.clipboard.writeText(text);
    toast({
      title: "Copied",
      description: "Text copied to clipboard",
    });
  };

  // Renamed getSeverityColor to avoid conflict with the one above
  const getSeverityColorTransaction = (severity: string) => {
    switch (severity) {
      case 'critical': return 'text-red-500 bg-red-500/10 border-red-500/20';
      case 'high': return 'text-orange-500 bg-orange-500/10 border-orange-500/20';
      case 'medium': return 'text-yellow-500 bg-yellow-500/10 border-yellow-500/20';
      default: return 'text-blue-500 bg-blue-500/10 border-blue-500/20';
    }
  };

  return (
    <div className="space-y-6">
      {/* Tab Selector */}
      <div className="flex gap-2 p-1 bg-muted rounded-lg">
        <Button
          type="button"
          variant={activeTab === 'scan' ? 'default' : 'ghost'}
          size="sm"
          className="flex-1"
          onClick={() => setActiveTab('scan')}
        >
          <AlertOctagon className="w-4 h-4 mr-2" />
          Vulnerability Scanner
        </Button>
        <Button
          type="button"
          variant={activeTab === 'transaction' ? 'default' : 'ghost'}
          size="sm"
          className="flex-1"
          onClick={() => setActiveTab('transaction')}
        >
          <Send className="w-4 h-4 mr-2" />
          Transaction Tools
        </Button>
        <Button
          type="button"
          variant={activeTab === 'der' ? 'default' : 'ghost'}
          size="sm"
          className="flex-1"
          onClick={() => setActiveTab('der')}
        >
          <Key className="w-4 h-4 mr-2" />
          DER Signature
        </Button>
        <Button
          type="button"
          variant={activeTab === 'rawtx' ? 'default' : 'ghost'}
          size="sm"
          className="flex-1"
          onClick={() => setActiveTab('rawtx')}
        >
          <Code className="w-4 h-4 mr-2" />
          Raw TX Builder
        </Button>
      </div>

      {/* Vulnerability Scanner Tab */}
      {activeTab === 'scan' && (
        <Card className="border-destructive/20 bg-destructive/5 shadow-lg shadow-destructive/10">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <AlertOctagon className="w-5 h-5 text-destructive" />
              ECDSA Nonce Reuse Detection
            </CardTitle>
            <p className="text-sm text-muted-foreground">
              Advanced algorithms for private key recovery from signature vulnerabilities
            </p>
          </CardHeader>

          <CardContent className="space-y-6">
            {/* Address Input Form */}
            <form onSubmit={addressForm.handleSubmit(onScanSubmit)} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="address">Bitcoin Address</Label>
                <Input
                  id="address"
                  placeholder="Enter Bitcoin address to analyze..."
                  {...addressForm.register("address")}
                />
                {addressForm.formState.errors.address && (
                  <p className="text-sm text-destructive">{addressForm.formState.errors.address.message}</p>
                )}
              </div>

              <Button
                type="submit"
                className="w-full"
                disabled={vulnerabilityScan.isPending}
                data-testid="button-run-vulnerability-scan"
              >
                <Shield className="w-4 h-4 mr-2" />
                {vulnerabilityScan.isPending ? 'Scanning...' : 'Run Comprehensive Vulnerability Analysis'}
              </Button>
            </form>

            <Separator />

            {/* Vulnerability Results */}
            {vulnerabilityScan.isPending ? (
              <div className="bg-muted/50 rounded-lg p-4">
                <div className="text-center py-8">
                  <div className="animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-2" />
                  <p className="text-muted-foreground text-sm">
                    Running comprehensive vulnerability analysis...
                  </p>
                </div>
              </div>
            ) : scanResult ? (
              <div className="space-y-6">
                {/* Detection Status */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <Card className="bg-destructive/10 border-destructive/20">
                    <CardContent className="p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-2 h-2 bg-destructive rounded-full animate-pulse" />
                        <span className="text-sm font-medium text-destructive">Critical</span>
                      </div>
                      <p className="text-2xl font-bold text-destructive" data-testid="critical-vulns">
                        {scanResult.vulnerabilities.filter(v => v.severity === 'critical').length}
                      </p>
                      <p className="text-xs text-muted-foreground">Nonce reuse instances</p>
                    </CardContent>
                  </Card>

                  <Card className="bg-orange-500/10 border-orange-500/20">
                    <CardContent className="p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-2 h-2 bg-orange-500 rounded-full" />
                        <span className="text-sm font-medium text-orange-500">High Risk</span>
                      </div>
                      <p className="text-2xl font-bold text-orange-500" data-testid="high-vulns">
                        {scanResult.vulnerabilities.filter(v => v.severity === 'high').length}
                      </p>
                      <p className="text-xs text-muted-foreground">Pattern vulnerabilities</p>
                    </CardContent>
                  </Card>

                  <Card className="bg-green-500/10 border-green-500/20">
                    <CardContent className="p-4">
                      <div className="flex items-center gap-2 mb-2">
                        <Key className="w-4 h-4 text-green-500" />
                        <span className="text-sm font-medium text-green-500">Recovered</span>
                      </div>
                      <p className="text-2xl font-bold text-green-500" data-testid="recovered-keys">
                        {scanResult.recoveredKeys.length}
                      </p>
                      <p className="text-xs text-muted-foreground">Private keys</p>
                    </CardContent>
                  </Card>
                </div>

                {/* Vulnerability Details */}
                {scanResult.vulnerabilities.length > 0 && (
                  <div className="space-y-4">
                    <h4 className="font-medium text-foreground">Detected Vulnerabilities</h4>
                    {scanResult.vulnerabilities.map((vuln, index) => (
                      <Card key={index} className={`border ${getSeverityColor(vuln.severity)}`}>
                        <CardContent className="p-4">
                          <div className="flex items-start justify-between mb-2">
                            <div className="flex items-center gap-2">
                              {getSeverityIcon(vuln.severity)}
                              <span className="font-medium" data-testid={`vulnerability-title-${index}`}>
                                {vuln.type === 'nonce_reuse' ? 'ECDSA Nonce Reuse - Private Key Recoverable' :
                                 vuln.type === 'sighash_single' ? 'SIGHASH_SINGLE Vulnerability' :
                                 vuln.type === 'weak_nonce_entropy' ? 'Weak Nonce Entropy Detected' :
                                 vuln.type === 'biased_nonce' ? 'Biased Nonce Generation' :
                                 vuln.type === 'poor_entropy' ? 'Poor Entropy Quality' :
                                 'Unknown Vulnerability Type'}
                              </span>
                            </div>
                            <Badge variant="outline" className={getSeverityColor(vuln.severity)}>
                              {vuln.severity.toUpperCase()}
                            </Badge>
                          </div>
                          <p className="text-sm text-muted-foreground mb-3">{vuln.description}</p>
                          {vuln.recoveredData && (
                            <div className="bg-muted/50 rounded p-3">
                              <span className="text-xs font-medium text-muted-foreground">Recovered Data:</span>
                              <pre className="text-xs font-mono text-foreground mt-1 whitespace-pre-wrap break-all">
                                {JSON.stringify(vuln.recoveredData, null, 2)}
                              </pre>
                            </div>
                          )}
                          <div className="flex gap-2 mt-2">
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => copyToClipboard(JSON.stringify(vuln, null, 2))}
                            >
                              <Copy className="w-3 h-3 mr-1" />
                              Copy
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                )}

                {/* Recovered Private Keys */}
                {scanResult.recoveredKeys.length > 0 && (
                  <div className="space-y-4">
                    <h4 className="font-medium text-foreground">Recovered Private Keys</h4>
                    <div className="bg-red-500/10 border border-red-500/20 rounded-lg p-4">
                      <div className="flex items-center gap-2 mb-3">
                        <AlertTriangle className="w-5 h-5 text-red-500" />
                        <span className="font-medium text-red-500">EDUCATIONAL DEMONSTRATION</span>
                      </div>
                      {scanResult.recoveredKeys.map((key, index) => (
                        <div key={index} className="space-y-2">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium">Private Key {index + 1}:</span>
                            <Badge variant="outline" className="bg-green-500/10 text-green-500 border-green-500/20">
                              {key.confidence}% Confidence
                            </Badge>
                          </div>
                          <div className="flex items-center gap-2">
                            <code className="flex-1 bg-muted rounded p-2 text-xs font-mono break-all">
                              {key.privateKey}
                            </code>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => copyToClipboard(key.privateKey)}
                            >
                              <Copy className="w-3 h-3" />
                            </Button>
                          </div>
                          <p className="text-xs text-muted-foreground">Method: {key.method}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Signature Analysis */}
                <div className="space-y-4">
                  <h4 className="font-medium text-foreground">Signature Analysis Summary</h4>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span className="text-muted-foreground">Total Signatures:</span>
                      <p className="font-mono text-foreground">{scanResult.signatureAnalysis.totalSignatures}</p>
                    </div>
                    <div>
                      <span className="text-muted-foreground">Unique R Values:</span>
                      <p className="font-mono text-foreground">{scanResult.signatureAnalysis.uniqueRValues}</p>
                    </div>
                    <div>
                      <span className="text-muted-foreground">Weak Patterns:</span>
                      <p className="font-mono text-orange-500">{scanResult.signatureAnalysis.weakPatterns.length}</p>
                    </div>
                    <div>
                      <span className="text-muted-foreground">Entropy Score:</span>
                      <p className="font-mono text-foreground">
                        {scanResult.signatureAnalysis.entropyAnalysis?.entropyScore || 'N/A'}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            ) : (
              <div className="bg-muted/50 rounded-lg p-4">
                <div className="text-center py-8">
                  <Shield className="w-8 h-8 text-muted-foreground mx-auto mb-2" />
                  <p className="text-muted-foreground text-sm" data-testid="no-scan-message">
                    Run comprehensive vulnerability analysis to detect ECDSA signature weaknesses
                  </p>
                  <p className="text-xs text-muted-foreground mt-2">
                    This tool will analyze Bitcoin transactions for nonce reuse, weak entropy, and other vulnerabilities
                  </p>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Transaction Creator Tab */}
      {activeTab === 'transaction' && (
        <Card className="border-blue-500/20 bg-blue-500/5 shadow-lg shadow-blue-500/10">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Wallet className="w-5 h-5 text-blue-500" />
              Bitcoin Transaction Creator
            </CardTitle>
            <p className="text-sm text-muted-foreground">
              Create Bitcoin transactions with DER signature encoding
            </p>
          </CardHeader>

          <CardContent className="space-y-6">
            <form onSubmit={transactionForm.handleSubmit(onTransactionSubmit)} className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="fromAddress">From Address</Label>
                  <Input
                    id="fromAddress"
                    placeholder="Source Bitcoin address"
                    {...transactionForm.register("fromAddress")}
                  />
                  {transactionForm.formState.errors.fromAddress && (
                    <p className="text-sm text-destructive">{transactionForm.formState.errors.fromAddress.message}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="toAddress">To Address</Label>
                  <Input
                    id="toAddress"
                    placeholder="Destination Bitcoin address"
                    {...transactionForm.register("toAddress")}
                  />
                  {transactionForm.formState.errors.toAddress && (
                    <p className="text-sm text-destructive">{transactionForm.formState.errors.toAddress.message}</p>
                  )}
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="amount">Amount (Satoshis)</Label>
                <Input
                  id="amount"
                  type="number"
                  placeholder="Amount in satoshis"
                  {...transactionForm.register("amount")}
                />
                {transactionForm.formState.errors.amount && (
                  <p className="text-sm text-destructive">{transactionForm.formState.errors.amount.message}</p>
                )}
              </div>

              <div className="space-y-2">
                <Label htmlFor="privateKey">Private Key (Educational)</Label>
                <Textarea
                  id="privateKey"
                  placeholder="Private key in hex format (for educational purposes only)"
                  rows={3}
                  className="font-mono text-sm"
                  {...transactionForm.register("privateKey")}
                />
                {transactionForm.formState.errors.privateKey && (
                  <p className="text-sm text-destructive">{transactionForm.formState.errors.privateKey.message}</p>
                )}
              </div>

              <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
                <div className="flex items-center gap-2 mb-2">
                  <AlertTriangle className="w-4 h-4 text-yellow-500" />
                  <span className="text-sm font-medium text-yellow-500">Educational Warning</span>
                </div>
                <p className="text-xs text-muted-foreground">
                  This tool is for educational purposes only. Never use real private keys or mainnet addresses.
                </p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Button
                  type="submit"
                  className="w-full"
                  disabled={createTransaction.isPending}
                >
                  <Send className="w-4 h-4 mr-2" />
                  {createTransaction.isPending ? 'Creating Transaction...' : 'Create Transaction with DER Signature'}
                </Button>

                <Button
                  type="button"
                  variant="outline"
                  className="w-full border-orange-500/20 hover:bg-orange-500/10"
                  disabled={!transactionResult || forgeSignature.isPending}
                  onClick={() => transactionResult && forgeSignature.mutate(transactionResult)}
                >
                  <Key className="w-4 h-4 mr-2" />
                  {forgeSignature.isPending ? 'Serializing...' : 'Serialize & Create Malleable Signature'}
                </Button>
              </div>
            </form>

            {transactionResult && (
              <div className="space-y-4">
                <Separator />
                <h4 className="font-medium text-foreground">Generated Transaction</h4>
                <div className="bg-muted/50 rounded-lg p-4">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-muted-foreground">Raw Transaction (Hex)</span>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => copyToClipboardTransaction(transactionResult)}
                    >
                      <Copy className="w-3 h-3 mr-1" />
                      Copy
                    </Button>
                  </div>
                  <pre className="text-xs font-mono text-foreground break-all whitespace-pre-wrap">
                    {transactionResult}
                  </pre>
                </div>
                <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                  <p className="text-sm text-green-600">
                    ✓ Transaction created successfully with DER signature encoding
                  </p>
                </div>

                {forgeSignature.isSuccess && (
                  <div className="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4">
                    <div className="flex items-center gap-2 mb-2">
                      <AlertTriangle className="w-4 h-4 text-orange-500" />
                      <span className="text-sm font-medium text-orange-500">Malleable Signature Created</span>
                    </div>
                    <p className="text-xs text-muted-foreground mb-2">
                      SIGHASH_SINGLE vulnerability exploited - signature malleability demonstrated
                    </p>
                    <div className="flex items-center gap-2">
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => copyToClipboardTransaction(transactionResult || '')}
                      >
                        <Copy className="w-3 h-3 mr-1" />
                        Copy Malleable TX
                      </Button>
                      <Badge variant="outline" className="bg-orange-500/10 text-orange-500 border-orange-500/20">
                        Serialized & Forged
                      </Badge>
                    </div>
                  </div>
                )}

                <Separator />

                {/* DER Signature Interface */}
                <Card className="border-purple-500/20 bg-purple-500/5">
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Key className="w-5 h-5 text-purple-500" />
                      DER Signature Interface
                    </CardTitle>
                    <p className="text-sm text-muted-foreground">
                      Sign raw transactions using parsed R and S values from DER signatures
                    </p>
                  </CardHeader>
                  <CardContent className="space-y-6">
                    <form onSubmit={derSignForm.handleSubmit(onDerSignSubmit)} className="space-y-4">
                      <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-3">
                          <Eye className="w-4 h-4 text-blue-500" />
                          <span className="text-sm font-medium text-blue-500">DER Signature Components</span>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <Label htmlFor="rValue">R Value (Hex)</Label>
                            <Input
                              id="rValue"
                              placeholder="Enter R value (64 chars hex)"
                              className="font-mono text-sm"
                              {...derSignForm.register("rValue")}
                            />
                            {derSignForm.formState.errors.rValue && (
                              <p className="text-sm text-destructive">{derSignForm.formState.errors.rValue.message}</p>
                            )}
                          </div>

                          <div className="space-y-2">
                            <Label htmlFor="sValue">S Value (Hex)</Label>
                            <Input
                              id="sValue"
                              placeholder="Enter S value (64 chars hex)"
                              className="font-mono text-sm"
                              {...derSignForm.register("sValue")}
                            />
                            {derSignForm.formState.errors.sValue && (
                              <p className="text-sm text-destructive">{derSignForm.formState.errors.sValue.message}</p>
                            )}
                          </div>
                        </div>
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="rawTransaction">Raw Transaction (Hex)</Label>
                        <Textarea
                          id="rawTransaction"
                          placeholder="Paste unsigned raw transaction hex here..."
                          rows={4}
                          className="font-mono text-sm"
                          {...derSignForm.register("rawTransaction")}
                        />
                        {derSignForm.formState.errors.rawTransaction && (
                          <p className="text-sm text-destructive">{derSignForm.formState.errors.rawTransaction.message}</p>
                        )}
                      </div>

                      <div className="bg-muted/50 rounded-lg p-4">
                        <h5 className="text-sm font-medium mb-3">Advanced Options</h5>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="space-y-2">
                            <Label htmlFor="sighashType">SIGHASH Type</Label>
                            <select
                              id="sighashType"
                              className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                              {...derSignForm.register("sighashType")}
                            >
                              <option value="1">SIGHASH_ALL (0x01)</option>
                              <option value="2">SIGHASH_NONE (0x02)</option>
                              <option value="3">SIGHASH_SINGLE (0x03)</option>
                              <option value="129">SIGHASH_ALL | ANYONECANPAY (0x81)</option>
                              <option value="130">SIGHASH_NONE | ANYONECANPAY (0x82)</option>
                              <option value="131">SIGHASH_SINGLE | ANYONECANPAY (0x83)</option>
                            </select>
                          </div>
                          <div className="space-y-2">
                            <Label htmlFor="publicKey">Public Key (Optional)</Label>
                            <Input
                              id="publicKey"
                              placeholder="33-byte compressed public key"
                              className="font-mono text-sm"
                              {...derSignForm.register("publicKey")}
                            />
                          </div>
                        </div>
                      </div>

                      <div className="flex gap-4">
                        <Button
                          type="submit"
                          className="flex-1"
                          disabled={signTransactionWithDer.isPending}
                        >
                          <Key className="w-4 h-4 mr-2" />
                          {signTransactionWithDer.isPending ? 'Signing Transaction...' : 'Sign with DER Components'}
                        </Button>
                        
                        <Button
                          type="button"
                          variant="outline"
                          className="px-8"
                          onClick={() => {
                            derSignForm.reset();
                            setTransactionResult(null);
                          }}
                        >
                          Clear
                        </Button>
                      </div>

                      <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <AlertTriangle className="w-4 h-4 text-yellow-500" />
                          <span className="text-sm font-medium text-yellow-500">DER Signature Process</span>
                        </div>
                        <p className="text-xs text-muted-foreground">
                          This interface allows you to sign transactions using pre-calculated R and S signature components.
                          The values will be DER-encoded and applied to the raw transaction for educational purposes.
                        </p>
                      </div>
                    </form>
                  </CardContent>
                </Card>

                {signTransactionWithDer.isSuccess && transactionResult && (
                  <div className="space-y-4">
                    <Separator />
                    <h4 className="font-medium text-foreground">Signed Transaction</h4>
                    <div className="bg-muted/50 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm text-muted-foreground">Signed Transaction (Hex)</span>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => copyToClipboardTransaction(transactionResult)}
                        >
                          <Copy className="w-3 h-3 mr-1" />
                          Copy
                        </Button>
                      </div>
                      <pre className="text-xs font-mono text-foreground break-all whitespace-pre-wrap">
                        {transactionResult}
                      </pre>
                    </div>
                    <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                      <p className="text-sm text-green-600">
                        ✓ Transaction signed successfully with provided DER components
                      </p>
                    </div>
                  </div>
                )}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* DER Signature Tab */}
      {activeTab === 'der' && (
        <Card className="border-purple-500/20 bg-purple-500/5 shadow-lg shadow-purple-500/10">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Key className="w-5 h-5 text-purple-500" />
              DER Signature Interface
            </CardTitle>
            <p className="text-sm text-muted-foreground">
              Advanced interface for signing transactions with DER-encoded R and S signature components
            </p>
          </CardHeader>

          <CardContent className="space-y-6">
            <form onSubmit={derSignForm.handleSubmit(onDerSignSubmit)} className="space-y-6">
              {/* DER Components Section */}
              <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <Eye className="w-5 h-5 text-blue-500" />
                  <span className="font-medium text-blue-500">ECDSA Signature Components</span>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="rValue" className="text-sm font-medium">R Value (Hex)</Label>
                    <Input
                      id="rValue"
                      placeholder="64-character hex string (e.g., a1b2c3d4...)"
                      className="font-mono text-sm"
                      {...derSignForm.register("rValue")}
                    />
                    {derSignForm.formState.errors.rValue && (
                      <p className="text-sm text-destructive">{derSignForm.formState.errors.rValue.message}</p>
                    )}
                    <p className="text-xs text-muted-foreground">The R component of the ECDSA signature</p>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="sValue" className="text-sm font-medium">S Value (Hex)</Label>
                    <Input
                      id="sValue"
                      placeholder="64-character hex string (e.g., e5f6g7h8...)"
                      className="font-mono text-sm"
                      {...derSignForm.register("sValue")}
                    />
                    {derSignForm.formState.errors.sValue && (
                      <p className="text-sm text-destructive">{derSignForm.formState.errors.sValue.message}</p>
                    )}
                    <p className="text-xs text-muted-foreground">The S component of the ECDSA signature</p>
                  </div>
                </div>
              </div>

              {/* Transaction Input Section */}
              <div className="space-y-4">
                <div className="flex items-center gap-2">
                  <Send className="w-4 h-4 text-foreground" />
                  <span className="font-medium">Transaction Data</span>
                </div>
                <div className="space-y-2">
                  <Label htmlFor="rawTransaction" className="text-sm font-medium">Raw Transaction (Hex)</Label>
                  <Textarea
                    id="rawTransaction"
                    placeholder="Paste unsigned raw transaction hex here..."
                    rows={5}
                    className="font-mono text-sm resize-none"
                    {...derSignForm.register("rawTransaction")}
                  />
                  {derSignForm.formState.errors.rawTransaction && (
                    <p className="text-sm text-destructive">{derSignForm.formState.errors.rawTransaction.message}</p>
                  )}
                  <p className="text-xs text-muted-foreground">
                    The unsigned transaction in hexadecimal format that will be signed with the DER components
                  </p>
                </div>
              </div>

              {/* Advanced Options */}
              <div className="bg-muted/30 rounded-lg p-4">
                <h5 className="text-sm font-medium mb-4 flex items-center gap-2">
                  <Settings className="w-4 h-4" />
                  Advanced Signature Options
                </h5>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="sighashType" className="text-sm font-medium">SIGHASH Type</Label>
                    <select
                      id="sighashType"
                      className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                      {...derSignForm.register("sighashType")}
                    >
                      <option value="1">SIGHASH_ALL (0x01) - Default</option>
                      <option value="2">SIGHASH_NONE (0x02)</option>
                      <option value="3">SIGHASH_SINGLE (0x03)</option>
                      <option value="129">SIGHASH_ALL | ANYONECANPAY (0x81)</option>
                      <option value="130">SIGHASH_NONE | ANYONECANPAY (0x82)</option>
                      <option value="131">SIGHASH_SINGLE | ANYONECANPAY (0x83)</option>
                    </select>
                    <p className="text-xs text-muted-foreground">Signature hash type flag</p>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="publicKey" className="text-sm font-medium">Public Key (Optional)</Label>
                    <Input
                      id="publicKey"
                      placeholder="33-byte compressed public key (hex)"
                      className="font-mono text-sm"
                      {...derSignForm.register("publicKey")}
                    />
                    <p className="text-xs text-muted-foreground">Corresponding public key for verification</p>
                  </div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-4">
                <Button
                  type="submit"
                  className="flex-1 bg-purple-600 hover:bg-purple-700"
                  disabled={signTransactionWithDer.isPending}
                >
                  <Key className="w-4 h-4 mr-2" />
                  {signTransactionWithDer.isPending ? 'Processing DER Signature...' : 'Sign Transaction with DER'}
                </Button>
                
                <Button
                  type="button"
                  variant="outline"
                  className="px-8"
                  onClick={() => {
                    derSignForm.reset();
                    setTransactionResult(null);
                  }}
                >
                  <AlertOctagon className="w-4 h-4 mr-2" />
                  Clear Form
                </Button>
              </div>

              {/* Educational Warning */}
              <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <AlertTriangle className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                  <div>
                    <span className="text-sm font-medium text-yellow-500 block mb-1">Educational DER Signature Tool</span>
                    <p className="text-xs text-muted-foreground">
                      This tool demonstrates how to construct and apply DER-encoded ECDSA signatures to Bitcoin transactions.
                      The R and S values should be valid elliptic curve signature components. This is for educational
                      purposes only and should not be used with real Bitcoin transactions.
                    </p>
                  </div>
                </div>
              </div>
            </form>

            {/* Results Section */}
            {signTransactionWithDer.isSuccess && transactionResult && (
              <div className="space-y-4">
                <Separator />
                <div className="space-y-4">
                  <h4 className="font-medium text-foreground flex items-center gap-2">
                    <CheckCircle className="w-4 h-4 text-green-500" />
                    DER Signed Transaction
                  </h4>
                  <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-sm font-medium text-green-600">Signed Transaction (Hex)</span>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => copyToClipboardTransaction(transactionResult)}
                      >
                        <Copy className="w-3 h-3 mr-1" />
                        Copy
                      </Button>
                    </div>
                    <pre className="text-xs font-mono text-foreground break-all whitespace-pre-wrap bg-background rounded p-3 border">
                      {transactionResult}
                    </pre>
                  </div>
                  <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-500" />
                      <span className="text-sm text-green-600 font-medium">
                        Transaction successfully signed with DER-encoded signature components
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Raw Transaction Builder Tab */}
      {activeTab === 'rawtx' && (
        <Card className="border-green-500/20 bg-green-500/5 shadow-lg shadow-green-500/10">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Code className="w-5 h-5 text-green-500" />
              Unsigned Raw Transaction Builder
            </CardTitle>
            <p className="text-sm text-muted-foreground">
              Build unsigned Bitcoin transactions with hex inputs and outputs
            </p>
          </CardHeader>

          <CardContent className="space-y-6">
            {/* UTXO Fetcher */}
            <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
              <h5 className="text-sm font-medium mb-3">Fetch UTXOs from Address</h5>
              <div className="flex gap-2 mb-3">
                <Input placeholder="Bitcoin address" value={utxoAddress} onChange={(e) => setUtxoAddress(e.target.value)} />
                <Button onClick={fetchUtxosForRawTx} disabled={utxoLoading} size="sm">
                  {utxoLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Wallet className="w-4 h-4 mr-1" />}
                  Fetch
                </Button>
              </div>
              {showUtxos && utxoList.length > 0 && (
                <div className="space-y-2 max-h-40 overflow-y-auto">
                  {utxoList.map((u, i) => (
                    <div key={i} className="flex items-center justify-between border rounded p-2 bg-muted/30 text-xs gap-2">
                      <span className="font-mono break-all">{u.txid}:{u.vout}</span>
                      <div className="flex gap-2">
                        <Badge variant="outline">{u.value} sat</Badge>
                        <Button size="sm" onClick={() => addUtxoToRawTx(u)}>Use</Button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <form onSubmit={rawTxForm.handleSubmit(onRawTxSubmit)} className="space-y-6">
              {/* Transaction Version and Locktime */}
              <div className="bg-muted/30 rounded-lg p-4">
                <h5 className="text-sm font-medium mb-4 flex items-center gap-2">
                  <Settings className="w-4 h-4" />
                  Transaction Parameters
                </h5>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <Label htmlFor="version" className="text-sm font-medium">Version</Label>
                    <Input
                      id="version"
                      placeholder="1"
                      className="font-mono text-sm"
                      {...rawTxForm.register("version")}
                    />
                    <p className="text-xs text-muted-foreground">Transaction version (usually 1 or 2)</p>
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="locktime" className="text-sm font-medium">Locktime</Label>
                    <Input
                      id="locktime"
                      placeholder="0"
                      className="font-mono text-sm"
                      {...rawTxForm.register("locktime")}
                    />
                    <p className="text-xs text-muted-foreground">Transaction locktime (0 for immediate)</p>
                  </div>
                </div>
              </div>

              {/* Transaction Inputs */}
              <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <Eye className="w-5 h-5 text-blue-500" />
                  <span className="font-medium text-blue-500">Transaction Inputs</span>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      const currentInputs = rawTxForm.getValues("inputs");
                      rawTxForm.setValue("inputs", [...currentInputs, { txid: "", vout: "", scriptSig: "", sequence: "ffffffff" }]);
                    }}
                  >
                    Add Input
                  </Button>
                </div>

                {rawTxForm.watch("inputs").map((_, index) => (
                  <div key={index} className="space-y-4 p-4 border rounded-lg mb-4">
                    <div className="flex items-center justify-between">
                      <h6 className="font-medium">Input #{index + 1}</h6>
                      {rawTxForm.watch("inputs").length > 1 && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => {
                            const currentInputs = rawTxForm.getValues("inputs");
                            rawTxForm.setValue("inputs", currentInputs.filter((_, i) => i !== index));
                          }}
                        >
                          Remove
                        </Button>
                      )}
                    </div>
                    
                    <div className="space-y-2">
                      <Label htmlFor={`inputs.${index}.txid`} className="text-sm font-medium">Previous Transaction ID</Label>
                      <Input
                        id={`inputs.${index}.txid`}
                        placeholder="64-character hex string (e.g., a1b2c3d4...)"
                        className="font-mono text-sm"
                        {...rawTxForm.register(`inputs.${index}.txid`)}
                      />
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor={`inputs.${index}.vout`} className="text-sm font-medium">Output Index (vout)</Label>
                        <Input
                          id={`inputs.${index}.vout`}
                          placeholder="0"
                          className="font-mono text-sm"
                          {...rawTxForm.register(`inputs.${index}.vout`)}
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor={`inputs.${index}.sequence`} className="text-sm font-medium">Sequence</Label>
                        <Input
                          id={`inputs.${index}.sequence`}
                          placeholder="ffffffff"
                          className="font-mono text-sm"
                          {...rawTxForm.register(`inputs.${index}.sequence`)}
                        />
                      </div>
                    </div>
                    
                    <div className="space-y-2">
                      <Label htmlFor={`inputs.${index}.scriptSig`} className="text-sm font-medium">Script Signature (Optional)</Label>
                      <Textarea
                        id={`inputs.${index}.scriptSig`}
                        placeholder="Leave empty for unsigned transaction"
                        rows={2}
                        className="font-mono text-sm resize-none"
                        {...rawTxForm.register(`inputs.${index}.scriptSig`)}
                      />
                      <p className="text-xs text-muted-foreground">ScriptSig in hex (leave empty for unsigned)</p>
                    </div>
                  </div>
                ))}
              </div>

              {/* Transaction Outputs */}
              <div className="bg-orange-500/10 border border-orange-500/20 rounded-lg p-6">
                <div className="flex items-center gap-2 mb-4">
                  <Send className="w-5 h-5 text-orange-500" />
                  <span className="font-medium text-orange-500">Transaction Outputs</span>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      const currentOutputs = rawTxForm.getValues("outputs");
                      rawTxForm.setValue("outputs", [...currentOutputs, { value: "", scriptPubKey: "" }]);
                    }}
                  >
                    Add Output
                  </Button>
                </div>

                {rawTxForm.watch("outputs").map((_, index) => (
                  <div key={index} className="space-y-4 p-4 border rounded-lg mb-4">
                    <div className="flex items-center justify-between">
                      <h6 className="font-medium">Output #{index + 1}</h6>
                      {rawTxForm.watch("outputs").length > 1 && (
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => {
                            const currentOutputs = rawTxForm.getValues("outputs");
                            rawTxForm.setValue("outputs", currentOutputs.filter((_, i) => i !== index));
                          }}
                        >
                          Remove
                        </Button>
                      )}
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label htmlFor={`outputs.${index}.value`} className="text-sm font-medium">Value (Satoshis)</Label>
                        <Input
                          id={`outputs.${index}.value`}
                          placeholder="100000"
                          className="font-mono text-sm"
                          {...rawTxForm.register(`outputs.${index}.value`)}
                        />
                        <p className="text-xs text-muted-foreground">Amount in satoshis (1 BTC = 100,000,000 sats)</p>
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor={`outputs.${index}.scriptPubKey`} className="text-sm font-medium">Script (Hex)</Label>
                        <Input
                          id={`outputs.${index}.scriptPubKey`}
                          placeholder="76a914...88ac"
                          className="font-mono text-sm"
                          {...rawTxForm.register(`outputs.${index}.scriptPubKey`)}
                        />
                      </div>
                    </div>
                    
                    <div className="bg-muted/50 rounded p-3">
                      <p className="text-xs text-muted-foreground mb-2">Common script templates:</p>
                      <div className="space-y-1 text-xs font-mono">
                        <p>P2PKH: 76a914[20-byte-hash]88ac</p>
                        <p>P2SH: a914[20-byte-hash]87</p>
                        <p>P2WPKH: 0014[20-byte-hash]</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {/* Action Buttons */}
              <div className="flex gap-4">
                <Button
                  type="submit"
                  className="flex-1 bg-green-600 hover:bg-green-700"
                  disabled={createRawTransaction.isPending}
                  onClick={() => {
                    setTimeout(() => {
                      if (transactionResult) setBuiltRawTx(transactionResult);
                    }, 100);
                  }}
                >
                  <Code className="w-4 h-4 mr-2" />
                  {createRawTransaction.isPending ? 'Building Transaction...' : 'Build Unsigned Raw Transaction'}
                </Button>

                <Button
                  type="button"
                  onClick={broadcastRawTx}
                  disabled={!builtRawTx || broadcastLoading}
                  className="flex-1 bg-orange-600 hover:bg-orange-700"
                >
                  {broadcastLoading ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Send className="w-4 h-4 mr-2" />}
                  {broadcastLoading ? 'Broadcasting...' : 'Broadcast to Blockchain'}
                </Button>
                
                <Button
                  type="button"
                  variant="outline"
                  className="px-8"
                  onClick={() => {
                    rawTxForm.reset();
                    setTransactionResult(null);
                    setBuiltRawTx("");
                  }}
                >
                  <AlertOctagon className="w-4 h-4 mr-2" />
                  Clear All
                </Button>
              </div>

              {/* Educational Warning */}
              <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <AlertTriangle className="w-5 h-5 text-yellow-500 flex-shrink-0 mt-0.5" />
                  <div>
                    <span className="text-sm font-medium text-yellow-500 block mb-1">Raw Transaction Builder</span>
                    <p className="text-xs text-muted-foreground">
                      This tool creates unsigned Bitcoin transactions in raw hex format. The transaction will not be valid
                      until properly signed. Use this for educational purposes and testing only. Never broadcast unsigned
                      transactions to the Bitcoin network.
                    </p>
                  </div>
                </div>
              </div>
            </form>

            {/* Results Section */}
            {createRawTransaction.isSuccess && transactionResult && (
              <div className="space-y-4">
                <Separator />
                <div className="space-y-4">
                  <h4 className="font-medium text-foreground flex items-center gap-2">
                    <CheckCircle className="w-4 h-4 text-green-500" />
                    Unsigned Raw Transaction
                  </h4>
                  <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-3">
                      <span className="text-sm font-medium text-green-600">Raw Transaction (Hex)</span>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => copyToClipboardTransaction(transactionResult)}
                      >
                        <Copy className="w-3 h-3 mr-1" />
                        Copy
                      </Button>
                    </div>
                    <pre className="text-xs font-mono text-foreground break-all whitespace-pre-wrap bg-background rounded p-3 border">
                      {transactionResult}
                    </pre>
                  </div>
                  
                  {/* Transaction Analysis */}
                  <div className="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                    <h5 className="text-sm font-medium text-blue-600 mb-3">Transaction Analysis</h5>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                      <div>
                        <span className="text-muted-foreground">Size:</span>
                        <p className="font-mono text-foreground">{Math.ceil(transactionResult.length / 2)} bytes</p>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Inputs:</span>
                        <p className="font-mono text-foreground">{rawTxForm.getValues("inputs").length}</p>
                      </div>
                      <div>
                        <span className="text-muted-foreground">Outputs:</span>
                        <p className="font-mono text-foreground">{rawTxForm.getValues("outputs").length}</p>
                      </div>
                    </div>
                  </div>

                  <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-3">
                    <div className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-green-500" />
                      <span className="text-sm text-green-600 font-medium">
                        Unsigned raw transaction created successfully - ready for signing or broadcasting
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Broadcast Result */}
            {broadcastResult && (
              <div className="space-y-4">
                <Separator />
                <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-4">
                  <h4 className="font-medium text-green-600 mb-3">✓ Transaction Broadcast Successfully!</h4>
                  <div className="space-y-3">
                    <div>
                      <p className="text-xs text-muted-foreground mb-1">Transaction ID (TXID)</p>
                      <div className="flex items-center gap-2">
                        <code className="text-xs font-mono bg-background p-2 rounded flex-1 break-all">{broadcastResult.txid}</code>
                        <Button size="sm" onClick={() => copyToClipboardTransaction(broadcastResult.txid)}>
                          <Copy className="w-3 h-3" />
                        </Button>
                      </div>
                    </div>
                    <div>
                      <p className="text-xs text-muted-foreground mb-1">Broadcast Endpoint</p>
                      <Badge>{broadcastResult.endpoint}</Badge>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}