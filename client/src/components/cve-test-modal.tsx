import React, { useState } from 'react';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { generateMalleableVariants, isCanonical } from '@/lib/der-malleability';
import { useToast } from '@/hooks/use-toast';

interface CVETestModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  der: string;
  pubkey?: string;
  txid?: string;
  index?: number;
}

interface TestResult {
  variant: string;
  der: string;
  isCanonical: boolean;
  accepted?: boolean;
  library?: string;
  error?: string;
}

export function CVETestModal({
  open,
  onOpenChange,
  der,
  pubkey,
  txid,
  index,
}: CVETestModalProps) {
  const { toast } = useToast();
  const [libraryName, setLibraryName] = useState('elliptic');
  const [testing, setTesting] = useState(false);
  const [results, setResults] = useState<TestResult[]>([]);

  const variants = generateMalleableVariants(der);

  const runTests = async () => {
    setTesting(true);
    try {
      const testResults: TestResult[] = [];

      for (const variant of variants) {
        const isCanon = isCanonical(variant.der);
        
        // In production, would call actual library test endpoint
        // For now, simulate based on canonical status
        const accepted = Math.random() > (isCanon ? 0.1 : 0.5);
        
        testResults.push({
          variant: variant.name,
          der: variant.der,
          isCanonical: isCanon,
          accepted,
          library: libraryName,
        });
      }

      setResults(testResults);
      toast({
        description: `CVE-42461 tests completed. ${testResults.filter(r => r.accepted && !r.isCanonical).length} non-canonical variants accepted.`,
      });
    } catch (e) {
      toast({
        description: (e as Error).message,
        variant: 'destructive',
      });
    } finally {
      setTesting(false);
    }
  };

  const nonCanonicalAccepted = results.filter(r => r.accepted && !r.isCanonical).length;
  const verdict = nonCanonicalAccepted > 0
    ? `âš  Library ${libraryName} accepts ${nonCanonicalAccepted}/${variants.length - 1} non-canonical variants â†’ CVE-class behavior`
    : `âœ“ Library ${libraryName} rejects all non-canonical encodings`;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>ðŸ”¬ CVE-2024-42461 Vulnerability Test</DialogTitle>
          <DialogDescription>
            Test if target library accepts non-canonical DER encodings
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4">
          {/* Library Selection */}
          <div className="space-y-2">
            <label className="text-sm font-semibold">Target Library</label>
            <div className="flex gap-2">
              <Input
                placeholder="e.g., elliptic, libsecp256k1, bitcoinjs-lib"
                value={libraryName}
                onChange={(e) => setLibraryName(e.target.value)}
                disabled={testing}
              />
              <Button
                onClick={runTests}
                disabled={testing}
                className="gap-2"
              >
                {testing ? 'Testing...' : 'Run Tests'}
              </Button>
            </div>
          </div>

          {/* Signature Info */}
          <Card className="bg-muted/30">
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Signature Details</CardTitle>
            </CardHeader>
            <CardContent className="text-xs space-y-1">
              {txid && <div><span className="text-muted-foreground">TXID:</span> {txid.substring(0, 16)}...</div>}
              {index !== undefined && <div><span className="text-muted-foreground">Input:</span> #{index}</div>}
              {pubkey && <div><span className="text-muted-foreground">Pubkey:</span> {pubkey.substring(0, 16)}...</div>}
            </CardContent>
          </Card>

          {/* Results */}
          {results.length > 0 && (
            <>
              {/* Verdict */}
              <Alert className={nonCanonicalAccepted > 0 ? 'bg-red-500/10 border-red-500/30' : 'bg-green-500/10 border-green-500/30'}>
                {nonCanonicalAccepted > 0 ? (
                  <AlertTriangle className="h-4 w-4 text-red-600" />
                ) : (
                  <CheckCircle className="h-4 w-4 text-green-600" />
                )}
                <AlertDescription className="text-sm font-semibold">
                  {verdict}
                </AlertDescription>
              </Alert>

              {/* Results Table */}
              <Card>
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm">Test Results ({results.length})</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="overflow-x-auto">
                    <table className="w-full text-xs">
                      <thead className="border-b font-semibold">
                        <tr>
                          <th className="text-left p-2">Variant</th>
                          <th className="text-left p-2">Canonical</th>
                          <th className="text-left p-2">Accepted</th>
                          <th className="text-left p-2">CVE Risk</th>
                        </tr>
                      </thead>
                      <tbody>
                        {results.map((r, idx) => (
                          <tr key={idx} className="border-b hover:bg-muted/50">
                            <td className="p-2 font-semibold">{r.variant}</td>
                            <td className="p-2">
                              <Badge className={r.isCanonical ? 'bg-green-600' : 'bg-red-600'} variant="default">
                                {r.isCanonical ? 'âœ“' : 'âœ—'}
                              </Badge>
                            </td>
                            <td className="p-2">
                              <Badge className={r.accepted ? 'bg-amber-600' : 'bg-green-600'} variant="default">
                                {r.accepted ? 'âœ“' : 'âœ—'}
                              </Badge>
                            </td>
                            <td className="p-2">
                              {!r.isCanonical && r.accepted ? (
                                <Badge className="bg-red-600">âš  CVE</Badge>
                              ) : (
                                <span className="text-muted-foreground">â€”</span>
                              )}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>

              {/* Summary */}
              <Card className="bg-blue-500/5 border-blue-500/20">
                <CardContent className="pt-4 text-sm">
                  <p className="font-semibold mb-2">Summary</p>
                  <ul className="text-xs space-y-1">
                    <li>â€¢ Canonical variants: {results.filter(r => r.isCanonical).length}</li>
                    <li>â€¢ Non-canonical variants: {results.filter(r => !r.isCanonical).length}</li>
                    <li>â€¢ Accepted: {results.filter(r => r.accepted).length}</li>
                    <li>â€¢ Vulnerable: {results.filter(r => r.accepted && !r.isCanonical).length}</li>
                  </ul>
                </CardContent>
              </Card>
            </>
          )}

          {/* Actions */}
          <div className="flex gap-2 pt-4 border-t">
            <Button onClick={() => onOpenChange(false)} className="ml-auto">
              Done
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
