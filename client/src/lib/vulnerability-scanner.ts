/**
 * Comprehensive vulnerability scanning for Bitcoin transactions
 */

import { TransactionInput } from '@/lib/transaction-analyzer';

export interface VulnerabilityIssue {
  severity: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  category: string;
  title: string;
  description: string;
  inputs?: number[];
  details?: Record<string, string | number>;
}

export interface VulnerabilityScanResult {
  txid?: string;
  timestamp: string;
  issues: VulnerabilityIssue[];
  summary: {
    criticalCount: number;
    highCount: number;
    mediumCount: number;
    lowCount: number;
    riskLevel: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'NONE';
  };
  details: {
    derValidation: string;
    sValues: string;
    nonceReuse: string;
    malleability: string;
  };
}

export function performVulnerabilityScan(
  inputs: TransactionInput[],
  txid?: string
): VulnerabilityScanResult {
  const issues: VulnerabilityIssue[] = [];

  // 1. DER/ASN.1 Validation
  const nonCanonicalInputs = inputs.filter(i => !i.signature?.isCanonical);
  if (nonCanonicalInputs.length > 0) {
    issues.push({
      severity: 'HIGH',
      category: 'DER/ASN.1',
      title: 'Non-canonical DER Encoding',
      description: `${nonCanonicalInputs.length} input(s) use non-canonical DER encoding - could indicate CVE-2024-42461 vulnerability`,
      inputs: nonCanonicalInputs.map(i => i.index),
      details: {
        'Non-canonical count': nonCanonicalInputs.length,
        'Total inputs': inputs.length,
      },
    });
  }

  // 2. High-S / Low-S Check
  const highSInputs = inputs.filter(i => i.signature?.isHighS);
  if (highSInputs.length > 0) {
    issues.push({
      severity: 'MEDIUM',
      category: 'Signature Malleability',
      title: 'High-S Values Detected',
      description: `${highSInputs.length} input(s) use high-S values - signature is malleable`,
      inputs: highSInputs.map(i => i.index),
      details: {
        'High-S count': highSInputs.length,
        'Recommendation': 'Normalize to low-S for BIP62 compliance',
      },
    });
  }

  // 3. Nonce Reuse Check (r-value collisions)
  const rValueMap = new Map<string, number[]>();
  inputs.forEach(i => {
    if (i.signature?.r) {
      const indices = rValueMap.get(i.signature.r) || [];
      indices.push(i.index);
      rValueMap.set(i.signature.r, indices);
    }
  });

  const nonceReuses = Array.from(rValueMap.entries()).filter(([_, indices]) => indices.length > 1);
  if (nonceReuses.length > 0) {
    nonceReuses.forEach(([r, indices]) => {
      issues.push({
        severity: 'CRITICAL',
        category: 'Cryptographic Weakness',
        title: `Nonce Reuse Detected (r-value collision)`,
        description: `Inputs ${indices.join(', ')} share the same r-value - private key recovery possible via ECDLP`,
        inputs: indices,
        details: {
          'r-value': r.substring(0, 16) + '...',
          'Affected inputs': indices.join(', '),
          'Risk': 'Private key can be recovered if two (r,s) pairs are known',
        },
      });
    });
  }

  // 4. CVE-2024-42461 Malleability Profile
  const vulnerableCount = inputs.filter(i => i.signature && (!i.signature.isCanonical || i.signature.isHighS)).length;
  if (vulnerableCount > 0) {
    issues.push({
      severity: 'HIGH',
      category: 'CVE-2024-42461',
      title: 'Potential Library Vulnerability (CVE-2024-42461)',
      description: `${vulnerableCount} input(s) could expose library to CVE-2024-42461 if target library accepts non-canonical encodings`,
      inputs: inputs.filter(i => i.signature && (!i.signature.isCanonical || i.signature.isHighS)).map(i => i.index),
      details: {
        'Non-canonical + High-S': vulnerableCount,
        'Recommendation': 'Test with CVE-42461 tester against target library',
      },
    });
  }

  // Calculate risk level
  const criticalCount = issues.filter(i => i.severity === 'CRITICAL').length;
  const highCount = issues.filter(i => i.severity === 'HIGH').length;
  const mediumCount = issues.filter(i => i.severity === 'MEDIUM').length;
  const lowCount = issues.filter(i => i.severity === 'LOW').length;

  let riskLevel: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW' | 'NONE' = 'NONE';
  if (criticalCount > 0) riskLevel = 'CRITICAL';
  else if (highCount > 0) riskLevel = 'HIGH';
  else if (mediumCount > 0) riskLevel = 'MEDIUM';
  else if (lowCount > 0) riskLevel = 'LOW';

  return {
    txid,
    timestamp: new Date().toISOString(),
    issues,
    summary: {
      criticalCount,
      highCount,
      mediumCount,
      lowCount,
      riskLevel,
    },
    details: {
      derValidation: `${nonCanonicalInputs.length} non-canonical DER encodings detected`,
      sValues: `${highSInputs.length} high-S values detected`,
      nonceReuse: `${nonceReuses.length} nonce reuse collision(s) detected`,
      malleability: `${vulnerableCount} inputs vulnerable to CVE-2024-42461`,
    },
  };
}
