. Transaction Hex Fetching for Every API

Weâ€™ll build a unified function: getTxHex(txid) that tries providers in order.

2.1 explorers/txHexFetcher.ts
// services/explorers/txHexFetcher.ts
import { torJson } from "../networking/torFetcher";
import fetch from "node-fetch"; // for endpoints returning text/hex

async function fetchText(url: string): Promise<string> {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return res.text();
}

// 1) Blockchain.info: /rawtx/{txid}?format=hex
async function hexFromBlockchain(txid: string): Promise<string> {
  const url = `https://blockchain.info/rawtx/${txid}?format=hex`;
  const txt = await fetchText(url); // returns plain hex
  return txt.trim();
}

// 2) Blockstream / Esplora: /api/tx/:txid/hex
async function hexFromBlockstream(txid: string): Promise<string> {
  const url = `https://blockstream.info/api/tx/${txid}/hex`;
  const txt = await fetchText(url);
  return txt.trim();
}

// 3) Mempool.space: /api/tx/:txid/hex
async function hexFromMempool(txid: string): Promise<string> {
  const url = `https://mempool.space/api/tx/${txid}/hex`; :contentReference[oaicite:0]{index=0}
  const txt = await fetchText(url);
  return txt.trim();
}

// 4) BlockCypher: includeHex=true
async function hexFromBlockcypher(txid: string): Promise<string> {
  const url = `https://api.blockcypher.com/v1/btc/main/txs/${txid}?includeHex=true`; :contentReference[oaicite:1]{index=1}
  const json = await torJson(url, {}, true);
  if (!json.hex) throw new Error("No hex field in BlockCypher response");
  return (json.hex as string).trim();
}

// Unified helper, tries multiple sources
export async function getTxHex(txid: string): Promise<string> {
  const providers = [
    hexFromBlockchain,
    hexFromBlockstream,
    hexFromMempool,
    hexFromBlockcypher,
  ];

  let lastErr: any = null;
  for (const fn of providers) {
    try {
      const hex = await fn(txid);
      if (!/^[0-9a-fA-F]+$/.test(hex)) throw new Error("Not valid hex");
      return hex;
    } catch (e) {
      lastErr = e;
      continue;
    }
  }

  throw new Error(`All providers failed for txid ${txid}: ${lastErr?.message || ""}`);
}


Now you can call await getTxHex(txid) anywhere in your pipeline.